{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Welcome Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-center">
                    <div class="text-center text-md-start mb-3 mb-md-0">
                        <h2 class="card-title mb-2">Welcome, {{ current_user.username }}!</h2>
                        <p class="card-text mb-0">Manage your IT support system efficiently.</p>
                    </div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                        <i class="fas fa-user-plus"></i> Add New User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-sm-6 col-md-3">
            <div class="card bg-primary text-white h-100">
                <div class="card-body">
                    <h5 class="card-title">Total Complaints</h5>
                    <h2 class="card-text mb-0">{{ complaints|length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-md-3">
            <div class="card bg-warning text-white h-100">
                <div class="card-body">
                    <h5 class="card-title">Open Complaints</h5>
                    <h2 class="card-text mb-0">{{ complaints|selectattr('status', 'equalto', 'Open')|list|length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-md-3">
            <div class="card bg-info text-white h-100">
                <div class="card-body">
                    <h5 class="card-title">In Progress</h5>
                    <h2 class="card-text mb-0">{{ complaints|selectattr('status', 'equalto', 'In Progress')|list|length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-md-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body">
                    <h5 class="card-title">Resolved</h5>
                    <h2 class="card-text mb-0">{{ complaints|selectattr('status', 'equalto', 'Resolved')|list|length }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Technician Performance -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Technician Performance</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportTechnicianData()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Technician</th>
                                    <th>Total Assigned</th>
                                    <th>Resolved</th>
                                    <th>In Progress</th>
                                    <th>Efficiency</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tech in technicians %}
                                {% set assigned = complaints|selectattr('technician_id', 'equalto', tech.id)|list %}
                                {% set resolved = assigned|selectattr('status', 'equalto', 'Resolved')|list %}
                                {% set in_progress = assigned|selectattr('status', 'equalto', 'In Progress')|list %}
                                {% set efficiency = (resolved|length / assigned|length * 100) if assigned|length > 0 else 0 %}
                                <tr {% if efficiency >= 80 %}class="table-success"{% endif %}>
                                    <td>{{ tech.username }}</td>
                                    <td>{{ assigned|length }}</td>
                                    <td>{{ resolved|length }}</td>
                                    <td>{{ in_progress|length }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress flex-grow-1 me-2" style="height: 20px;">
                                                <div class="progress-bar {% if efficiency >= 80 %}bg-success{% elif efficiency >= 50 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                     role="progressbar" 
                                                     style="width: {{ efficiency }}%"
                                                     aria-valuenow="{{ efficiency }}" 
                                                     aria-valuemin="0" 
                                                     aria-valuemax="100">
                                                </div>
                                            </div>
                                            <span>{{ "%.1f"|format(efficiency) }}%</span>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Department Issues -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Department Issues</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportDepartmentData()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Department</th>
                                    <th>Total Issues</th>
                                    <th>Common Problems</th>
                                    <th>Trend</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for dept in departments %}
                                <tr>
                                    <td>{{ dept.name }}</td>
                                    <td>{{ dept.total_issues }}</td>
                                    <td>
                                        <div class="text-truncate" style="max-width: 200px;" title="{{ dept.common_problems|join(', ') if dept.common_problems else 'N/A' }}">
                                            {{ dept.common_problems|join(', ') if dept.common_problems else 'N/A' }}
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge {% if dept.trend == 'increasing' %}bg-danger{% elif dept.trend == 'decreasing' %}bg-success{% else %}bg-warning{% endif %}">
                                            {{ dept.trend|title }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hardware Issues and Predictions -->
    <div class="row g-4 mb-4">
        <div class="col-12 col-lg-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Hardware Issues</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportHardwareData()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Hardware Type</th>
                                    <th>Total Issues</th>
                                    <th>Common Problems</th>
                                    <th>Resolution Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for hw in hardware_issues %}
                                <tr>
                                    <td>{{ hw.type }}</td>
                                    <td>{{ hw.total_issues }}</td>
                                    <td>
                                        <div class="text-truncate" style="max-width: 150px;" title="{{ hw.common_problems|join(', ') if hw.common_problems else 'N/A' }}">
                                            {{ hw.common_problems|join(', ') if hw.common_problems else 'N/A' }}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress flex-grow-1 me-2" style="height: 20px;">
                                                <div class="progress-bar {% if hw.resolution_rate >= 80 %}bg-success{% elif hw.resolution_rate >= 50 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                     role="progressbar" 
                                                     style="width: {{ hw.resolution_rate }}%"
                                                     aria-valuenow="{{ hw.resolution_rate }}" 
                                                     aria-valuemin="0" 
                                                     aria-valuemax="100">
                                                </div>
                                            </div>
                                            <span>{{ hw.resolution_rate }}%</span>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Failure Predictions</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportPredictionData()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Employee</th>
                                    <th>Department</th>
                                    <th>Hardware</th>
                                    <th>Predicted Failure</th>
                                    <th>Risk Level</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pred in predictions %}
                                <tr>
                                    <td>{{ pred.employee }}</td>
                                    <td>{{ pred.department }}</td>
                                    <td>{{ pred.hardware }}</td>
                                    <td>{{ pred.predicted_failure }}</td>
                                    <td>
                                        <span class="badge bg-{{ pred.risk_level_color }}">
                                            {{ pred.risk_level }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- All Complaints -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">All Complaints</h5>
                    <div class="d-flex gap-2">
                        <div class="input-group" style="width: 300px;">
                            <input type="text" class="form-control" id="searchInput" placeholder="Search complaints...">
                            <button class="btn btn-outline-secondary" type="button">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-secondary" onclick="exportComplaints('excel')">
                                <i class="fas fa-file-excel"></i> Excel
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="exportComplaints('csv')">
                                <i class="fas fa-file-csv"></i> CSV
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="complaintsTable">
                            <thead>
                                <tr>
                                    <th>Complaint No</th>
                                    <th>Employee</th>
                                    <th>Department & Code</th>
                                    <th>Issue</th>
                                    <th>Status</th>
                                    <th>Priority</th>
                                    <th>Assigned To</th>
                                    <th>Created At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for complaint in complaints %}
                                <tr>
                                    <td>
                                        <span class="badge bg-light text-dark">
                                            {{ complaint.complaint_no }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-user text-primary me-2"></i>
                                            {{ complaint.employee_name if complaint.employee_name else complaint.user.username }}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-building text-info me-2"></i>
                                            {{ complaint.employee_department if complaint.employee_department else complaint.user.department }}({{ complaint.user.employee_code }})
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-exclamation-circle text-warning me-2"></i>
                                            {{ complaint.issue[:100] }}{% if complaint.issue|length > 100 %}...{% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        {% if complaint.status == 'Open' %}
                                            <span class="badge bg-warning status-badge">
                                                <i class="fas fa-clock me-1"></i>Open
                                            </span>
                                        {% elif complaint.status == 'In Progress' %}
                                            <span class="badge bg-info status-badge">
                                                <i class="fas fa-spinner me-1"></i>In Progress
                                            </span>
                                        {% elif complaint.status == 'Resolved' %}
                                            <span class="badge bg-success status-badge">
                                                <i class="fas fa-check-circle me-1"></i>Resolved
                                            </span>
                                        {% else %}
                                            <span class="badge bg-danger status-badge">
                                                <i class="fas fa-exclamation-triangle me-1"></i>Escalated
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if complaint.priority == 'High' %}
                                            <span class="badge bg-danger priority-badge">
                                                <i class="fas fa-arrow-up me-1"></i>High
                                            </span>
                                        {% elif complaint.priority == 'Medium' %}
                                            <span class="badge bg-warning priority-badge">
                                                <i class="fas fa-minus me-1"></i>Medium
                                            </span>
                                        {% else %}
                                            <span class="badge bg-success priority-badge">
                                                <i class="fas fa-arrow-down me-1"></i>Low
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-user-tie text-primary me-2"></i>
                                            {{ complaint.technician.username if complaint.technician else 'Unassigned' }}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-calendar-alt text-muted me-2"></i>
                                            {{ complaint.created_at.strftime('%Y-%m-%d %H:%M') }}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-info" onclick="viewComplaint({{ complaint.id }})" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-primary" onclick="assignTechnician({{ complaint.id }})" title="Assign Technician">
                                                <i class="fas fa-user-plus"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteComplaint({{ complaint.id }})" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <div class="text-muted">
                                            <i class="fas fa-inbox fa-2x mb-2"></i>
                                            <p class="mb-0">No complaints found</p>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Complaint Modal -->
<div class="modal fade" id="viewComplaintModal" tabindex="-1" aria-labelledby="viewComplaintModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewComplaintModalLabel">
                    <i class="fas fa-ticket-alt me-2"></i>Complaint Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3">Complaint Information</h6>
                        <p><strong>Complaint No:</strong> <span id="complaintNo"></span></p>
                        <p><strong>Status:</strong> <span id="complaintStatus"></span></p>
                        <p>
                            <strong>Priority:</strong> 
                            <span id="complaintPriority"></span>
                            <button class="btn btn-sm btn-outline-secondary ms-2" id="changePriorityBtn" title="Change Priority">
                                <i class="fas fa-edit"></i>
                            </button>
                        </p>
                        <div class="change-priority-container d-none mb-3">
                            <div class="input-group input-group-sm">
                                <select class="form-select form-select-sm" id="prioritySelect">
                                    <option value="Low">Low</option>
                                    <option value="Medium">Medium</option>
                                    <option value="High">High</option>
                                </select>
                                <button class="btn btn-primary" type="button" id="updatePriorityBtn">Update</button>
                                <button class="btn btn-secondary" type="button" id="cancelPriorityBtn">Cancel</button>
                            </div>
                            <small class="text-muted">Set high priority for urgent issues that need immediate attention</small>
                        </div>
                        <p><strong>Created At:</strong> <span id="complaintCreatedAt"></span></p>
                        <p><strong>Assigned To:</strong> <span id="complaintAssignedTo"></span></p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3">Employee Details</h6>
                        <p><strong>Name:</strong> <span id="employeeName"></span></p>
                        <p><strong>Designation:</strong> <span id="employeeDesignation"></span></p>
                        <p><strong>Department:</strong> <span id="employeeDepartment"></span></p>
                        <p><strong>Issue:</strong> <span id="complaintIssue"></span></p>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-12">
                        <h6 class="text-muted mb-3">Troubleshooting Steps</h6>
                        <div id="troubleshootingSteps" class="bg-light p-3 rounded">
                            <!-- Troubleshooting steps will be displayed here -->
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-12">
                        <h6 class="text-muted mb-3">Comments</h6>
                        <div id="complaintComments" class="bg-light p-3 rounded">
                            <!-- Comments will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Assign Technician Modal -->
<div class="modal fade" id="assignTechnicianModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Technician</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="assignTechnicianForm">
                    <input type="hidden" id="assignComplaintId">
                    <div class="mb-3">
                        <label for="technicianSelect" class="form-label">Select Technician</label>
                        <select class="form-select" id="technicianSelect" required>
                            {% for tech in technicians %}
                            <option value="{{ tech.id }}">{{ tech.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitTechnicianAssignment()">Assign</button>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <div class="mb-3">
                        <label for="role" class="form-label">Role</label>
                        <select class="form-select" id="role" required>
                            <option value="employee">Employee</option>
                            <option value="technician">Technician</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="department" class="form-label">Department</label>
                        <input type="text" class="form-control" id="department" required>
                    </div>
                    <div class="mb-3">
                        <label for="designation" class="form-label">Designation</label>
                        <input type="text" class="form-control" id="designation" required>
                    </div>
                    <div class="mb-3">
                        <label for="employeeCode" class="form-label">Employee Code</label>
                        <input type="text" class="form-control" id="employeeCode" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitNewUser()">Add User</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Auto-refresh dashboard every 30 seconds (if no modals are open)
setInterval(function() {
    if (!document.querySelector('.modal.show')) {
        location.reload();
    }
}, 30000);

// Update statistics every 10 seconds
setInterval(function() {
    if (!document.querySelector('.modal.show')) {
        updateStatistics();
    }
}, 10000);

// Function to update statistics
function updateStatistics() {
    fetch('/admin/dashboard/stats')
        .then(response => response.json())
        .then(data => {
            // Update statistics cards
            document.querySelector('.bg-primary .card-text').textContent = data.total;
            document.querySelector('.bg-warning .card-text').textContent = data.open;
            document.querySelector('.bg-info .card-text').textContent = data.in_progress;
            document.querySelector('.bg-success .card-text').textContent = data.resolved;
        })
        .catch(error => console.error('Error updating statistics:', error));
}

// Function to update complaint status
function updateComplaintStatus(complaintId, newStatus) {
    fetch(`/complaint/${complaintId}/update_status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ status: newStatus })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error updating status: ' + data.error);
        }
    })
    .catch(error => console.error('Error:', error));
}

// Function to update complaint priority
function updateComplaintPriority(complaintId, newPriority) {
    fetch(`/complaint/${complaintId}/update_priority`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ priority: newPriority })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Priority updated successfully');
            
            // Update UI without reloading
            const priorityBadge = document.getElementById('complaintPriority');
            if (priorityBadge) {
                priorityBadge.innerHTML = `<span class="badge ${getPriorityBadgeClass(newPriority)}">${newPriority}</span>`;
            }
            
            // Hide the priority change container
            document.querySelector('.change-priority-container').classList.add('d-none');
        } else {
            showToast('Error updating priority: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error updating priority', 'error');
    });
}

// Function to update technician assignment
function updateTechnicianAssignment(complaintId, technicianId) {
    fetch(`/complaint/${complaintId}/assign_technician`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ technician_id: technicianId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Technician assigned successfully');
        } else {
            showToast('Error assigning technician: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error assigning technician', 'error');
    });
}

// Function to view complaint details
function viewComplaint(complaintId) {
    console.log('Fetching complaint details for ID:', complaintId); // Debug log
    
    fetch(`/complaint/${complaintId}`)
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Received complaint data:', data); // Debug log
            
            // Store complaint ID for later use with priority update
            document.getElementById('viewComplaintModal').setAttribute('data-complaint-id', complaintId);
            
            // Update modal content with fallback values
            document.getElementById('complaintNo').textContent = data.complaint_no || 'N/A';
            document.getElementById('complaintStatus').innerHTML = `<span class="badge ${getStatusBadgeClass(data.status)}">${data.status || 'Unknown'}</span>`;
            document.getElementById('complaintPriority').innerHTML = `<span class="badge ${getPriorityBadgeClass(data.priority)}">${data.priority || 'Unknown'}</span>`;
            
            // Set the current priority in the select dropdown
            const prioritySelect = document.getElementById('prioritySelect');
            if (prioritySelect) {
                for (let i = 0; i < prioritySelect.options.length; i++) {
                    if (prioritySelect.options[i].value === data.priority) {
                        prioritySelect.selectedIndex = i;
                        break;
                    }
                }
            }
            
            document.getElementById('complaintCreatedAt').textContent = data.created_at ? new Date(data.created_at).toLocaleString() : 'N/A';
            document.getElementById('complaintAssignedTo').textContent = data.technician ? data.technician.username : 'Unassigned';
            document.getElementById('employeeName').textContent = data.employee_name || 'N/A';
            document.getElementById('employeeDesignation').textContent = data.employee_designation || 'N/A';
            document.getElementById('employeeDepartment').textContent = data.employee_department || 'N/A';
            document.getElementById('complaintIssue').textContent = data.issue || 'No issue description available';
            
            // Format troubleshooting steps with fallback
            const troubleshootingSteps = data.troubleshooting_steps ? 
                data.troubleshooting_steps.replace(/\n/g, '<br>') : 
                'No troubleshooting steps available';
            document.getElementById('troubleshootingSteps').innerHTML = troubleshootingSteps;
            
            // Format comments with fallback
            const commentsHtml = data.comments && data.comments.length > 0 ? 
                data.comments.map(comment => `
                    <div class="comment mb-2">
                        <strong>${comment.user.username}</strong> (${new Date(comment.created_at).toLocaleString()})
                        <p class="mb-0">${comment.content}</p>
                    </div>
                `).join('') : 
                'No comments yet';
            document.getElementById('complaintComments').innerHTML = commentsHtml;
            
            // Set up priority change button handlers
            const changePriorityBtn = document.getElementById('changePriorityBtn');
            const priorityContainer = document.querySelector('.change-priority-container');
            const updatePriorityBtn = document.getElementById('updatePriorityBtn');
            const cancelPriorityBtn = document.getElementById('cancelPriorityBtn');
            
            if (changePriorityBtn && priorityContainer && updatePriorityBtn && cancelPriorityBtn) {
                // Remove any existing event listeners (to prevent duplicates)
                const newChangePriorityBtn = changePriorityBtn.cloneNode(true);
                changePriorityBtn.parentNode.replaceChild(newChangePriorityBtn, changePriorityBtn);
                
                const newUpdatePriorityBtn = updatePriorityBtn.cloneNode(true);
                updatePriorityBtn.parentNode.replaceChild(newUpdatePriorityBtn, updatePriorityBtn);
                
                const newCancelPriorityBtn = cancelPriorityBtn.cloneNode(true);
                cancelPriorityBtn.parentNode.replaceChild(newCancelPriorityBtn, cancelPriorityBtn);
                
                // Show/hide priority change controls
                newChangePriorityBtn.addEventListener('click', function() {
                    priorityContainer.classList.remove('d-none');
                    newChangePriorityBtn.classList.add('d-none');
                });
                
                // Cancel priority change
                newCancelPriorityBtn.addEventListener('click', function() {
                    priorityContainer.classList.add('d-none');
                    newChangePriorityBtn.classList.remove('d-none');
                });
                
                // Update priority
                newUpdatePriorityBtn.addEventListener('click', function() {
                    const newPriority = document.getElementById('prioritySelect').value;
                    updateComplaintPriority(complaintId, newPriority);
                });
            }
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('viewComplaintModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error fetching complaint details:', error);
            alert(`Error loading complaint details: ${error.message}. Please check the console for more information.`);
        });
}

function getStatusBadgeClass(status) {
    switch(status) {
        case 'Open': return 'bg-warning';
        case 'In Progress': return 'bg-info';
        case 'Resolved': return 'bg-success';
        default: return 'bg-secondary';
    }
}

function getPriorityBadgeClass(priority) {
    switch(priority) {
        case 'High': return 'bg-danger';
        case 'Medium': return 'bg-warning';
        case 'Low': return 'bg-success';
        default: return 'bg-secondary';
    }
}

// Function to delete complaint
function deleteComplaint(complaintId) {
    if (confirm('Are you sure you want to delete this complaint?')) {
        fetch(`/complaint/${complaintId}/delete`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Complaint deleted successfully');
                location.reload();
            } else {
                showToast('Error deleting complaint: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error deleting complaint', 'error');
        });
    }
}

// Function to submit new user
function submitNewUser() {
    const userData = {
        username: document.getElementById('username').value,
        email: document.getElementById('email').value,
        password: document.getElementById('password').value,
        role: document.getElementById('role').value,
        department: document.getElementById('department').value,
        designation: document.getElementById('designation').value,
        employee_code: document.getElementById('employeeCode').value
    };
    
    fetch('/admin/add_user', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(userData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('User added successfully');
            location.reload();
        } else {
            alert('Failed to add user');
        }
    })
    .catch(error => console.error('Error:', error));
}

// Function to show toast messages
function showToast(message, type = 'success') {
    const toastContainer = document.createElement('div');
    toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    toastContainer.style.zIndex = '1050';
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    document.body.appendChild(toastContainer);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        toastContainer.remove();
    });
}

// Export functions
function exportComplaints(format) {
    const url = format === 'excel' 
        ? "{{ url_for('export_complaints_excel') }}"
        : "{{ url_for('export_complaints_csv') }}";
    
    window.location.href = url;
}

function exportTechnicianData() {
    window.location.href = '/admin/export/technicians';
}

function exportDepartmentData() {
    window.location.href = '/admin/export/departments';
}

function exportHardwareData() {
    window.location.href = '/admin/export/hardware';
}

function exportPredictionData() {
    window.location.href = '/admin/export/predictions';
}

// Search functionality
document.getElementById('searchInput').addEventListener('keyup', function() {
    const searchText = this.value.toLowerCase();
    const table = document.getElementById('complaintsTable');
    const rows = table.getElementsByTagName('tr');
    
    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.getElementsByTagName('td');
        let found = false;
        
        for (let j = 0; j < cells.length; j++) {
            const cell = cells[j];
            if (cell.textContent.toLowerCase().includes(searchText)) {
                found = true;
                break;
            }
        }
        
        row.style.display = found ? '' : 'none';
    }
});

// Technician assignment change handler
document.querySelectorAll('.technician-select').forEach(select => {
    select.addEventListener('change', function() {
        const complaintId = this.dataset.complaintId;
        const technicianId = this.value;
        if (technicianId) {
            updateTechnicianAssignment(complaintId, technicianId);
        }
    });
});

function assignTechnician(complaintId) {
    document.getElementById('assignComplaintId').value = complaintId;
    new bootstrap.Modal(document.getElementById('assignTechnicianModal')).show();
}

function submitTechnicianAssignment() {
    const complaintId = document.getElementById('assignComplaintId').value;
    const technicianId = document.getElementById('technicianSelect').value;
    
    fetch(`/complaint/${complaintId}/assign_technician`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ technician_id: technicianId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Failed to assign technician');
        }
    })
    .catch(error => console.error('Error:', error));
}
</script>
{% endblock %} 